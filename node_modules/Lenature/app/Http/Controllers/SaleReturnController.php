<?php

namespace App\Http\Controllers;

use App\Models\Order;
use App\Models\Product;
use App\Models\SaleReturn;
use App\Models\SaleReturnDetails;
use Carbon\Carbon;
use Illuminate\Http\Request;

class SaleReturnController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $items = SaleReturn::all();
        return view('sale-return.index')->with(compact('items'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $prefix = 'SOR'; // Example prefix
        $dateComponent = now()->format('Ymd'); // Current date component
        $incrementalNumber = SaleReturn::count() + 1; // Incremental number

        $invoiceNumber = $prefix . str_pad($incrementalNumber, 4, '0', STR_PAD_LEFT);
        $items = Product::all();
        return view('sale-return.create')->with(compact('invoiceNumber','items'));
   
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $validatedData = $request->validate([
            'return_invoice_number' => 'required',
            'invoice_number' => 'required',
            'customer_name' => 'required',
            'customer_mobile' => 'required',
            'order_date' => 'required|date_format:d-m-Y',
            'grand_total' => 'required|numeric',
            'order_items.*.batch_code' => 'required',
            'order_items.*.product_id' => 'required',
            'order_items.*.quantity' => 'required|integer|min:1',
            'order_items.*.item_price' => 'required|numeric|min:0',
            'order_items.*.total' => 'required|numeric|min:0',
        ]);
    
        // Create a new Order instance
        $order = new SaleReturn();
        $item = Order::where('invoice_no',$validatedData['invoice_number'])->first();
        $order->invoice_no = $validatedData['invoice_number'];
        $order->return_invoice_no = $validatedData['return_invoice_number'];
        $order->return_invoice_date = Carbon::createFromFormat('d-m-Y', $validatedData['order_date'])->format('Y-m-d');
        $order->total_amount = $validatedData['grand_total'];
        $order->order_id = $item->id;
        $order->save();
    
        // Create order details for each item
        foreach ($validatedData['order_items'] as $itemData) {
            $product = Product::where('batch_code', $itemData['batch_code'])->first();
            if ($product) {
                $orderDetail = new SaleReturnDetails();
                $orderDetail->return_order_id = $order->id;
                $orderDetail->batch_code = $itemData['batch_code'];
                $orderDetail->product_id = $product->id;
                $orderDetail->product_name = $itemData['product_id'];
                $orderDetail->qty = $itemData['quantity'];
                $orderDetail->item_price = $itemData['item_price'];
                $orderDetail->total_price = $itemData['total'];
                $orderDetail->save();
            $product->available_qty = $product->available_qty + $orderDetail->qty;
            $product->save();
            } else {
                // Handle the case where the product with the given batch code is not found
                // You might want to log an error or perform some other action here
            }
        }
    
        // Create a new Customer instance
        // $customer = new Vendor();
        // $customer->vendor_name = $validatedData['vendor_name'];
        // $customer->vendor_mobile = $validatedData['vendor_mobile'];
        // $customer->purchase_return_id = $order->id;
        // $customer->save();
        // $customer = Vendor::where('purchase_return_id',);
        // Associate the customer with the order
        $customer = Order::where('invoice_no', $order->invoice_no)->first();
       
        $order->customer_id = $customer->customer_id;
        $order->save();
        $orderData = [
            'customer_name' => $customer->customer->customer_name,
            'customer_mobile' => $customer->customer->customer_mobile,
            'order_date' => $order->invoice_date,
            'invoice_number' => $order->invoice_no,
            'grand_total' => $order->total_amount,
            'items' => $order->orderDetails()->get() // Assuming you have defined the relationship in your Order model
        ];
    
        // Return the invoice data as a response
        return response()->json(['success' => true, 'order' => $orderData]);
        // return redirect('/purchase-returns');
    }

    /**
     * Display the specified resource.
     */
    public function show(SaleReturn $saleReturn)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(SaleReturn $saleReturn)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, SaleReturn $saleReturn)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(SaleReturn $saleReturn)
    {
        //
    }
}
