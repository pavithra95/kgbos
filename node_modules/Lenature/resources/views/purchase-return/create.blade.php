@extends('layouts.app')

@section('title', 'KGGL')

@section('content_header')
@stop

@section('content')
<div id="app" class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <h4 class="m-0 text-dark col-md-6 float-left">Purchase Return Bill</h4>
                    </div>
                </div>
                <br>

                <form id="order-form" action="/purchase-returns" method="POST" role="form" class="col-md-12" autocomplete="off" @submit.prevent="submitForm">
                    {{ csrf_field() }}

                    <div class="row">
                       
                        <div class="col-md-6">
                            <div class="form-group @if($errors->has('name')) text-danger @endif">
                                <label for="">Return Invoice Number</label>
                                <input type="text"  name="return_invoice_number" class="form-control" v-model="return_invoice_number" required="" readonly>
                                <input type="hidden"  name="return_invoice_number" class="form-control" v-model="return_invoice_number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group @if($errors->has('name')) text-danger @endif">
                                <label for="">Invoice Number</label>
                                <input type="text"  name="invoice_number" class="form-control" v-model="invoice_number" required="" @change="fetchOrderDetails">
                                <!-- <input type="hidden"  name="invoice_number" class="form-control" v-model="invoice_number"> -->
                            </div>
                        </div>
                       
                        <div class="col-md-6">
                            <div class="form-group @if($errors->has('date')) text-danger @endif">
                                <label for="">Return Invoice Date</label>
                                <input type="text" name="order_date" class="form-control date-picker" v-model="order_date" required="" disabled>
                                <input type="hidden" name="order_date" class="form-control date-picker" v-model="order_date" required="">
                                @if($errors->has('date'))
                                <div class="error text-danger">{{ $errors->first('date') }}</div>
                                @endif
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group @if($errors->has('name')) text-danger @endif">
                                <label for="">Vendor Name</label>
                                <input type="text" name="vendor_name" class="form-control" v-model="vendor_name" required="">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group @if($errors->has('status')) text-danger @endif">
                                <label for="">Vendor Mobile Number</label>
                                <input type="text" name="vendor_mobile" class="form-control" v-model="vendor_mobile" required="">
                            </div>
                        </div>
                    </div>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Batch Code</th>
                                <th>Item Name</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="item in order_items">
                                <input type="hidden" name="batch_code[]" :value="item.batch_code">
                                <input type="hidden" name="product_id[]" :value="item.product_id">
                                <input type="hidden" name="quantity[]" :value="item.quantity">
                                <input type="hidden" name="item_price[]" :value="item.item_price">
                                <input type="hidden" name="total[]" :value="item.total">
                            </template>
                            <input type="hidden" name="grand_total" :value="grandTotal">
                            
                            <tr v-for="(item, index) in order_items" :key="index">
                                <td style="width: 300px;">
                                    <input :id="'batch_code_' + index" class="form-control" type="text" v-model="item.batch_code" @change="fetchProductDetails(index)" @keypress.enter.prevent="handleEnterKey(index)">
                                </td>
                                <td style="width: 300px;">
                                    <input class="form-control" type="text" v-model="item.product_id">
                                </td>
                                <td style="width: 150px;"><input class="form-control" type="number" :min="1" :max="item.available_qty" @input="checkQuantityLimit(index)"  v-model="item.quantity" @input="calculateTotal(index)" @keydown.enter.prevent="handleKeyPress(index, $event)"></td>
                                <td style="width: 150px;"><input class="form-control" type="number" v-model="item.item_price" @input="calculateTotal(index)" readonly></td>
                                <td style="width: 150px;"><input class="form-control" type="number" v-model="item.total" readonly></td>
                                <td style="color: red" @click="removeRow(index)">X</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="text-right">Grand Total:</td>
                                <td><input class="form-control" type="number" :value="grandTotal" readonly></td>
                                <!-- <td><a :disabled="!isBatchCodeFilled" href="" @click.prevent="addItem" class="btn btn-primary">+</a></td> -->
                            </tr>
                        </tbody>
                    </table>
                    <button type="submit" class="btn btn-primary col-md-2 offset-md-4 btn-sm">Submit</button>
                    <a class="btn btn-danger col-md-2 btn-sm" href='/product-categories'>Cancel</a>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<link href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/ui-lightness/jquery-ui.css' rel='stylesheet'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://unpkg.com/vue-select@latest"></script>
<link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

<script>
    $(document).ready(function() {
        $('#batch_code_0').focus();
    });

    Vue.component('v-select', VueSelect.VueSelect);
    $(document).ready(function() {
        $('.date-picker').datepicker({
            format: 'dd-mm-yyyy',
            autoclose: true
        }).on('changeDate', function(e) {
            app.order_date = $(this).val();
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        new Vue({
            el: '#app',
            data: {
                vendor_name: '',
                vendor_mobile: '',
                order_date: '{{ now()->format('d-m-Y')}}',
                return_invoice_number:'{{$invoiceNumber}}',
                invoice_number:'',
                
                order_items: [{
                    batch_code: '',
                    product_id: '',
                    quantity: 1,
                    item_price: 0,
                    total: 0,
                   
                }],
                items: [
                    @foreach($items as $item) {
                        id: "{{$item->id}}",
                        name: "{{$item->product_name}}",
                        final_price: "{{$item->final_price}}",
                        available_qty: "{{$item->available_qty}}",
                    },
                    @endforeach
                ],
                isError: false,
                isBatchCodeFilled: false
            },
            computed: {
                grandTotal: function() {
                    return this.order_items.reduce((sum, item) => sum + (item.total || 0), 0);
                }
            },
            methods: {
                removeRow: function(index) {
                    this.order_items.splice(index, 1);
                },
                addItem: function() {
                    if (this.isBatchCodeFilled) { // Check if batch_code is filled
                        this.order_items.push({
                            batch_code: '',
                            product_id: '',
                            quantity: 1,
                            notes: null,
                            item_price: 0,
                            total: 0,
                            available_qty: 0,
                            purchase_order_qty: 0
                        });
                        // this.isBatchCodeFilled = false;

                        // Wait for Vue to render the new row, then focus the batch code input field
                        this.$nextTick(() => {
                            const lastIndex = this.order_items.length - 1;
                            const batchCodeInput = document.getElementById(`batch_code_${lastIndex}`);
                            if (batchCodeInput) {
                                batchCodeInput.focus();
                            }
                        });
                    }
                },
                fetchProductDetails: function(index) {
                    const batchCode = this.order_items[index].batch_code;
                    this.isBatchCodeFilled = batchCode.trim() !== '';
                    axios.post('/get-product-details', {
                        _token: '{{ csrf_token() }}',
                        batch_code: batchCode
                    })
                    .then(response => {
                        if (response.data.success) {
                            const product = response.data.product;
                            const existingItemIndex = this.order_items.findIndex(item => item.batch_code === batchCode);

                            if (existingItemIndex !== -1 && existingItemIndex !== index) {
                                // If the item already exists (other than the current index), update its quantity
                                this.order_items[existingItemIndex].quantity += this.order_items[index].quantity;
                                this.calculateTotal(existingItemIndex);
                                this.order_items.splice(index, 1); // Remove the duplicated row
                            } else {
                                // If the item does not exist, update the current row
                                this.order_items[index].product_id = product.product_name;
                                this.order_items[index].item_price = product.final_price;
                                this.calculateTotal(index);
                            }
                        } else {
                            alert('Product details not found for this batch code.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching product details:', error);
                    });
                },
                fetchOrderDetails: function() {
                    axios.post('/purchase-returns/get-order-details', {
                        _token: '{{ csrf_token() }}',
                        invoice_number: this.invoice_number
                    })
                    .then(response => {
                        if (response.data.success) {
                            const order = response.data.order;
                            const vendor = response.data.vendor;
                            this.order_items = order.map(item => ({
                                // console.log(item.productItem.available_qty);
                                batch_code: item.batch_code,
                                product_id: item.product_name,
                                quantity: item.qty,
                                item_price: item.item_price,
                                total: item.total_price,
                                available_qty:item.product.available_qty,
                                purchase_order_qty: item.qty
                            }));
                            this.vendor_name = vendor.vendor_name;
                            this.vendor_mobile = vendor.vendor_mobile;
                            // this.order_date = order.order_date;
                        } else {
                            alert('Order not found for this invoice number.');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching order details:', error);
                    });
                },
                calculateTotal: function(index) {
                    const item = this.order_items[index];
                    item.total = item.quantity * item.item_price;
                },
                checkQuantityLimit: function(index) {
                    const item = this.order_items[index];
                    if (item.quantity > item.available_qty) {
                    item.quantity = item.available_qty;
                    alert('The quantity entered exceeds the available stock.');
                    } else if (item.quantity > item.purchase_order_qty) {
                        item.quantity = item.purchase_order_qty;
                        alert('The quantity entered exceeds the quantity in the original sale order.');
                    }
                    this.calculateTotal(index);
                },
                submitForm: function() {
                    console.log("Submit button clicked");
                    if (this.isValidForm()) {
                        console.log("Form is valid, submitting");

                        axios.post('/purchase-returns', {
                            _token: '{{ csrf_token() }}',
                            vendor_name: this.vendor_name,
                            vendor_mobile: this.vendor_mobile,
                            order_date: this.order_date,
                            invoice_number: this.invoice_number,
                            return_invoice_number: this.return_invoice_number,
                            order_items: this.order_items,
                            grand_total: this.grandTotal
                        })
                        .then(response => {
                            if (response.data.success) {
                                window.location.href = '/purchase-returns';
            } else {
                alert('Error creating order.');
            }
                        })
                        .catch(error => {
                            console.error('Error creating order:', error);
                        });

                    } else {
                        console.log("Form is invalid, not submitting");
                        alert('Please fill out all required fields.');
                    }
                },
                isValidForm: function() {
                    // Add your validation logic here
                    // For simplicity, let's just check if customer name and mobile number are filled
                    if (this.vendor_name && this.vendor_mobile) {
                        return true;
                    }
                    return false;
                },
                handleEnterKey: function(index) {
                    console.log('Enter key pressed for batch code at index:', index);
                    this.fetchProductDetails(index);
                },
                handleKeyPress: function(index, event) {
                    if (event.keyCode === 13) { // Check if Enter key is pressed
                        if (index === this.order_items.length - 1) { // Check if it's the last row
                            this.addItem(); // Add a new row
                        }
                    }
                },
                showInvoice: function(order) {
                    // Prepare the invoice content
                    const invoiceContent = `
                        <div class="header">
                            <h2>SHOP NAME</h2>
                            <p>Address Green Tree Saravanampatti</p>
                            <p>TEL:9878676789</p>
                        </div>
                        <hr>
                        <p>Customer Name: ${order.customer_name}</p>
                        <p>Customer Mobile: ${order.customer_mobile}</p>
                        <p>Date: ${order.order_date}</p>
                        <p>Order No: ${order.invoice_number}</p>
                        <hr>
                        <table>
                            <tr>
                                <th>S.No</th>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                            ${order.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.product_name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.item_price}</td>
                                    <td>${item.total}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <hr>
                        <div class="price">
                            <h4>Total Amount:</h4>
                            <h4>${order.grand_total}</h4>
                        </div>
                        <hr>
                        <h4 class="greet">***THANK YOU***</h4>
                    `;
                    document.getElementById('invoiceContent').innerHTML = invoiceContent;
                    $('#invoiceModal').modal('show');
                },
                printInvoice: function() {
                    const invoiceContent = document.getElementById('invoiceContent').innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write('<html><head><title>Print Invoice</title>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(invoiceContent);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.print();
                }
            }
        });
    });
</script>

@stop
